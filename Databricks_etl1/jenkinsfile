pipeline {
    agent any

    options {
        timeout(time: 30, unit: 'MINUTES')
        retry(1)
    }

    parameters {
        choice(
            name: 'TARGET',
            choices: ['dev', 'prod'],
            description: 'Databricks bundle target environment'
        )
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Setup Python Environment') {
            steps {
                script {
                    sh '''
                        python3 --version
                        pip3 --version || echo "pip3 not found, installing..."
                        python3 -m pip install --upgrade pip setuptools wheel || true
                    '''
                }
            }
        }

        stage('Install Databricks CLI') {
            steps {
                script {
                    sh '''
                        if ! command -v databricks &> /dev/null; then
                            echo "Installing Databricks CLI..."
                            pip3 install databricks-cli --upgrade
                        else
                            echo "Databricks CLI already installed"
                            databricks --version
                        fi
                    '''
                }
            }
        }

        stage('Validate Bundle') {
            steps {
                withCredentials([string(credentialsId: 'databricks-pat', variable: 'DATABRICKS_TOKEN')]) {
                    script {
                        sh '''
                            export DATABRICKS_TOKEN="${DATABRICKS_TOKEN}"
                            databricks bundle validate -t ${TARGET}
                        '''
                    }
                }
            }
        }

        stage('Deploy Bundle') {
            steps {
                withCredentials([string(credentialsId: 'databricks-pat', variable: 'DATABRICKS_TOKEN')]) {
                    script {
                        sh '''
                            export DATABRICKS_TOKEN="${DATABRICKS_TOKEN}"
                            databricks bundle deploy -t ${TARGET}
                        '''
                    }
                }
            }
        }

        stage('Run ELT Pipeline Job') {
            steps {
                withCredentials([string(credentialsId: 'databricks-pat', variable: 'DATABRICKS_TOKEN')]) {
                    script {
                        sh '''
                            export DATABRICKS_TOKEN="${DATABRICKS_TOKEN}"
                            databricks bundle run elt_pipeline_job -t ${TARGET}
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
        always {
            cleanWs()
        }
    }
}
